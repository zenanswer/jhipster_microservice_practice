<img src="https://avatars1.githubusercontent.com/u/6059488?s=200&v=4" height="32">

<img src="https://www.jhipster.tech/images/logo/jhipster_family_member_2.svg" height="64">


# A Microservice on K8s be generated by [jhipster](https://www.jhipster.tech/)

# File structure

```text
‚îú‚îÄ‚îÄ apache-maven-3.6.1-bin.zip
‚îú‚îÄ‚îÄ maven-wrapper-0.5.4.jar
‚îú‚îÄ‚îÄ app1
‚îú‚îÄ‚îÄ app2      # two sample app
‚îú‚îÄ‚îÄ gateway   # API gateway
‚îú‚îÄ‚îÄ uaa       # UAA
‚îî‚îÄ‚îÄ k8s       # K8s deployment scripts
```

üóíÔ∏è Some times, is difficult to download maven zip and maven-wrapper jar from the mainland, so I upload them here and modify the maven-wrapper.properties. Please DO modify the file path if you want to compile them.

```text
localhost:jhipster_microservice_practice xcwang$ cat app1/.mvn/wrapper/maven-wrapper.properties
distributionUrl=file:///Users/xcwang/dev/project/jhipster/apache-maven-3.6.1-bin.zip
wrapperUrl=file:///Users/xcwang/dev/project/jhipster/maven-wrapper-0.5.4.jar
localhost:jhipster_microservice_practice xcwang$
```

# How to generate a Microservice

## Using the jhipster tool-kit through docker for generating source code

https://www.jhipster.tech/installation/

```bash
$ docker image pull jhipster/jhipster:v6.3.0
$ mkdir jhipster_microservice_practice
$ docker container run \
--name jhipster \
-v `pwd`/jhipster_microservice_practice:/home/jhipster/app \
-v ~/.m2:/home/jhipster/.m2 \
-p 8080:8080 -p 9000:9000 -p 3001:3001 \
-d -t jhipster/jhipster
```

Login the container and generate

```bash
$ docker container exec -it jhipster bash
$ cd /home/jhipster/app
$ mkdir uaa  gateway app1 app2 k8s
```

To generate "uaa", "gateway", and two empty app, "app1" and "app2" with command "jhipster" in the corresponding sub folder.

To generate the K8s deployment scripts under "k8s" sub folder with command "jhipster kubernetes".

üóíÔ∏è All default options shoule be OK.

## To compile and deploy

https://www.jhipster.tech/kubernetes/

At the end of the output of command "jhipster kubernetes", you should got those info like this below:

```text
...
WARNING! Kubernetes configuration generated, but no Jib cache found
If you forgot to generate the Docker image for this application, please run:
To generate the missing Docker image(s), please run:
  ./mvnw -Pprod verify jib:dockerBuild in /home/jhipster/app/app1
  ./mvnw -Pprod verify jib:dockerBuild in /home/jhipster/app/app2
  ./mvnw -Pprod verify jib:dockerBuild in /home/jhipster/app/gateway
  ./mvnw -Pprod verify jib:dockerBuild in /home/jhipster/app/uaa

WARNING! You will need to push your image to a registry. If you have not done so, use the following commands to tag and push the images:
  docker image tag app1 csmssim01:80/tagjhipster/app1
  docker push csmssim01:80/tagjhipster/app1
  docker image tag app2 csmssim01:80/tagjhipster/app2
  docker push csmssim01:80/tagjhipster/app2
  docker image tag gateway csmssim01:80/tagjhipster/gateway
  docker push csmssim01:80/tagjhipster/gateway
  docker image tag uaa csmssim01:80/tagjhipster/uaa
  docker push csmssim01:80/tagjhipster/uaa

You can deploy all your apps by running the following script:
  bash kubectl-apply.sh

Use these commands to find your application's IP addresses:
  kubectl get svc gateway -n tag

INFO! Congratulations, JHipster execution is complete!
jhipster@b2bd366f588e:~/app/k8s$

```

1. compiling source code into docker with command "./mvnw -Pprod verify jib:dockerBuild in {PATH on host}/app1", please DO modify the path from the container path "/home/jhipster/app/" to the host path.
2. tag the image and push them into your docker repository. My repository is "csmssim01" here.
3. To copy "k8s" folder to your k8s environment.
4. To deploy all your apps by running the following script "kubectl-apply.sh" under "k8s" folder.

üóíÔ∏è The k8s namespace in my sample is "tag".

If everything is OK, you could got those output from kubect like this:

```text
[root@k8s01 k8s_practice]# kubectl -n tag get pod
NAME                                             READY   STATUS    RESTARTS   AGE
app1-68fd954c6d-btgdz                            1/1     Running   4          6d
app1-mysql-66544b5cc9-sn5xv                      1/1     Running   4          6d
app2-7bccdbd9bb-tkz59                            1/1     Running   10         6d
app2-mysql-57bd5d4fff-4kzc8                      1/1     Running   4          6d
gateway-78fc6c84c9-fps2z                         1/1     Running   67         6d
gateway-mysql-6c7bb4bf4c-6gj9j                   1/1     Running   50         6d
jhipster-console-6f4f8468d9-wk8ts                1/1     Running   4          6d
jhipster-elasticsearch-client-5c86c5c78d-rt8x6   1/1     Running   3          31h
jhipster-elasticsearch-data-0                    1/1     Running   9          26h
jhipster-elasticsearch-master-0                  1/1     Running   2          26h
jhipster-logstash-5994d46747-5tpk6               1/1     Running   4          6d
jhipster-registry-0                              1/1     Running   4          5d23h
jhipster-registry-1                              1/1     Running   4          5d23h
jhipster-zipkin-5f8966bb88-mw4d8                 1/1     Running   103        6d
uaa-696559dddc-v69rm                             1/1     Running   8          6d
uaa-mysql-6f9bd97f69-9pw46                       1/1     Running   4          6d
[root@k8s01 k8s_practice]# kubectl -n tag get svc
NAME                               TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE
app1                               ClusterIP      10.100.2.18      <none>        8081/TCP            6d
app1-mysql                         ClusterIP      10.109.192.119   <none>        3306/TCP            6d
app2                               ClusterIP      10.109.108.231   <none>        8081/TCP            6d
app2-mysql                         ClusterIP      10.104.61.70     <none>        3306/TCP            6d
gateway                            LoadBalancer   10.103.6.151     10.10.11.70   8080:32093/TCP      6d
gateway-mysql                      ClusterIP      10.109.88.48     <none>        3306/TCP            6d
jhipster-console                   LoadBalancer   10.102.105.61    10.10.11.71   5601:31185/TCP      6d
jhipster-elasticsearch             ClusterIP      10.110.103.27    <none>        9200/TCP            5d23h
jhipster-elasticsearch-data        ClusterIP      10.101.206.179   <none>        9300/TCP            5d23h
jhipster-elasticsearch-discovery   ClusterIP      10.97.207.91     <none>        9300/TCP            5d23h
jhipster-logstash                  ClusterIP      10.98.2.164      <none>        5000/UDP,5000/TCP   6d
jhipster-registry                  LoadBalancer   10.103.252.70    10.10.11.72   8761:32637/TCP      5d23h
jhipster-zipkin                    ClusterIP      10.97.108.153    <none>        9411/TCP            6d
uaa                                ClusterIP      10.97.45.66      <none>        9999/TCP            6d
uaa-mysql                          ClusterIP      10.108.182.72    <none>        3306/TCP            6d
[root@k8s01 k8s_practice]#
```
